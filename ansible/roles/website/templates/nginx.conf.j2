server {
    server_name  www.{{ item.domain }};
    rewrite ^(.*) http://{{ item.domain }}$1 permanent;
}

server {
        listen {% if item.ssl is defined %}443{% else %}80{% endif %};
        server_name {{ item.domain }};
                root   /var/www/{{ item.domain }}/{{ item.web_dir | default('web') }};
                index index.php;
        include /etc/nginx/security;

        # Logging
        {% if env != 'prod' %}
        access_log  /var/log/nginx/{{ item.domain }}.access.log;
        error_log  /var/log/nginx/{{ item.domain }}.error.log debug;
        {% else %}
        access_log  /var/log/nginx/access.log;
        error_log  /var/log/nginx/error.log warn;
        {% endif %}

        # serve static files directly
        location ~* ^.+.(jpg|jpeg|gif|css|png|js|ico|html|xml|txt)$ {
            {% if env == 'prod' %}
            access_log        off;
            expires           max;
            {% endif %}
        }
 
        location ~ \.php$ {
        try_files $uri =404;
                fastcgi_pass unix:/var/run/php5-fpm/{{ item.domain }}.socket;
                fastcgi_index index.php;
                include /etc/nginx/fastcgi_params;
        }
}
